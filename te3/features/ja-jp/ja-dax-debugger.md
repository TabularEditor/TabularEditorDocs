# DAXデバッガー

> [!NOTE]
> DAXデバッガーはバージョン3.2.0で導入されました。 この記事の情報は、デバッガーの機能追加に伴い変更される可能性があります。

<iframe width="560" height="315" src="https://www.youtube.com/embed/m4g9BxcUf4U" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

DAXは比較的複雑な言語であり、使いこなすのが難しいことは周知の事実です。ほとんどのデータモデル開発者は、DAXコードが期待した結果を返さないという状況を経験したことがあるでしょう。このような場合、コードを変数ごとに、関数コールごとに分解すると、何が起こっているのかをよりよく理解できます。

これまでは、クライアントツールで実行されたDAXクエリをキャプチャして、[DAX Studio](https://daxstudio.org/)や[SQL Server Management Studio](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15)でクエリを分解して実行するという面倒で時間のかかる作業が多かったのですが、この「分解」作業が不要になったことでコードの信頼性が向上しました。

Tabular Editor 3は**DAXデバッガー**という概念を導入しました。これは、モデルのDAXコードに踏み込むプロセスを、より簡単にするツールです。コンセプトレベルでは、このデバッガーはC#アプリケーションを開発する際にVisual Studioで見られるような従来のIDEデバッガーと似ています。

## 前提条件

DAXデバッガーは、モデル内のDAXコードを解析し、サブ式や行コンテキストなどを評価するための適切なDAXクエリを生成し、インタラクティブな方法でコードを実行できます。

この機能を使用するには、Power BI DesktopやAnalysis Servicesの他のインスタンスから直接モデルメタデータをロードする場合など、Tabular Editor 3が**接続**または**ワークスペースモード**で動作している必要があります。

## はじめに

Tabular Editor 3がAnalysis Servicesのインスタンスに接続されている間、デバッガーは2つの異なる方法のいずれかで起動できます。

- ピボットグリッド
- DAXクエリ

デバッガーを起動すると、デバッグ中のコードに関するコンテキスト情報を提供する新しいビューが多数表示され、現在デバッグされているコードの部分をハイライト表示するDAXスクリプト ビューも表示されます。

> [!TIP]
> デバッグセッションを開始する前に、DAXコードを読みやすくするための書式設定を検討してください。

## ピボットグリッドによるデバッグ

1. ピボットグリッドの新規作成 (**File > New > Pivot Grid**)
2. デバッグするメジャーをピボット・グリッドに追加します。以下のいずれかを実行します。
  - TOMエクスプローラからメジャーをドラッグする、または
  - TOM Explorer でメジャーを右クリックし、**Add to pivot grid** を選択します。
  - ピボット・グリッドのフィールド・リストからメジャーを選択します (**ピボット・グリッド > フィールドの表示**)
3. (オプション）フィルタ領域、列領域、または行領域で、ピボットグリッドに1つまたは複数の列を追加します。
4. Pivot Grid内の値セルを右クリックし、**Debug this value**を選択します。

![Debug From Pivot](../../../images/debug-from-pivot.png)

## DAXクエリによるデバッグ

1. 新しいDAXクエリを作成する (**File > New > DAX Query**).
2. DAXクエリを入力または貼り付けます。これは通常、Power BIのビジュアルによって生成されるような、1つ以上の (明示的な)メジャーを持つ `SUMMARIZECOLUMNS` 呼び出しで構成されるクエリであるべきです。

> [!TIP]
> Power BI Desktop の[Performance Analyzer](https://docs.microsoft.com/ja-jp/power-bi/create-reports/desktop-performance-analyzer)を使用すると、ビジュアルで生成されたクエリを取り込むことができます。

3. F5を押して、Tabular Editor 3でクエリを実行する。デバッグしたい値を探し、セルを右クリックして、**Debug** を選択します。

![Debug From Query](../../../images/debug-from-query.png)

## デバッグビュー

デバッガーには、以下のビューがあります（非表示の場合は、**デバッグ > Windows** メニューからアクセスできます）。

- Locals
- Watch
- Evaluation Context
- Call Tree

### Locals

このビューでは、現在の実行範囲内の列、メジャー、および変数が一覧表示され、それらの値が表示されます。また、現在デバッグされているサブ式の値も表示されます。このリストの値は、別のサブ式に移動するとき、または評価コンテキストが変更されるときに自動的に更新されます。**ローカル値は、常にコールツリーの現在選択されている項目で評価されます。

![Locals](../../../images/locals.png)

### Watch

このビューでは、現在の評価コンテキスト内で計算される任意のDAX式を入力できます。表式だけでなくスカラー式も入力でき、利用可能なすべてのDAX関数を使用して、現在の評価範囲内の変数を参照できます。ウォッチ値は、異なる部分式に移動したとき、または評価コンテキストが変更されたときに自動的に更新されます。**ウォッチ値は、常に評価コンテキスト・スタックで現在選択されている項目のスコープで評価されます。

![Watch](../../../images/watch.png)

変数、メジャー、サブ式をウォッチビューにすばやく追加するには、コードの一部をハイライトして、ウォッチビューにドラッグするだけです。また、追加したい式の上にカーソルを置き、右クリックして、**Watch this expression**を選択することもできます。

![Quick Add To Watch](../../../images/quick-add-to-watch.png)

ウォッチ式の追加、複製、削除は、ウォッチビューの右クリックコンテキストメニューを使用します。

![Watch Context Menu](../../../images/watch-context-menu.png)

**Generate query** オプションは、下のスクリーンショットでハイライトされている **Value** カラム内のZoomボタンと同じものです。これをクリックすると、デバッガーは新しいDAXクエリ文書を開き、計算のコンテキストと計算自体を定義して、結果をより詳細に調べることができます。これは、以下のように、ウォッチ式がテーブル式の場合にとくに便利です。

![Inspect Watch](../../../images/inspect-watch.png)

### Evaluation Context

このビューは、現在の部分式のDAX評価コンテキストに関する情報を提供します。例たとえば、 `CALCULATE` 式はコンテキストトランジションを実行したり、評価コンテキストにフィルターを追加したり、あるいは `SUMX` イテレータは行コンテキストを追加するかもしれません。

![Evaluation Context](../../../images/evaluation-context.png)

評価コンテキストスタックの項目をダブルクリックして、その項目にフォーカスを移すことができます。これにより、すべての**Watch**式が新しいコンテキストで再評価されます（つまり、スタックの一番下から、現在フォーカスされている項目までのすべてのコンテキストが再評価されます）。これは、以下のアニメーションで説明されています。また、アクティブな反復処理内の行をページングすることによって、アクティブな行のコンテキストで個々の列の値を検査することができることにも注目してください。

![Call Tree](../../../images/navigating-evaluation-context.gif)

また、外側のフィルターコンテキストから個々のフィルターを切り替えることもできます（たとえば、クエリを生成した[`SUMMARIZECOLUMNS`](https://dax.guide/summarizecolumns)の呼び出しや、ピボットグリッドの指定したフィルターで列をグループ化するなど）。これは、以下のアニメーションで説明されています。このように切り替えたフィルターは、ウォッチとローカルの両方に適用されます。

![Call Tree](../../../images/toggle-filters.gif)

最後に、**Row** 列のZoomボタンをクリックすると、イテレータの最初の1000行を参照し、現在の行コンテキストをその最初の1000行の中の特定の行に設定できます。

![Browse Row Contexts](../../../images/browse-row-contexts.png)

### Call Tree

このビューには計算全体のアウトラインが表示され、ダブルクリックで簡単にサブ式間を移動できます（ショートカットキーによる移動も可能です）。ツリーには、コンテキストトランジション、イテレーション、行コンテキストに関する情報も表示されます。実行されないコード（たとえば `IF` や `SWITCH` の呼び出しや、イテレータが空のとき）のブランチは、取り消し線が引かれます。

![Call Tree](../../../images/call-tree.png)

コールツリーのアイテム間を移動すると、デバッグDAXスクリプトはコールツリーアイテムに対応するコードを強調表示し、同時に強調表示されたコードに到達するまでの経路を（灰色の背景で）表示します（下図参照）。

![Call Tree](../../../images/navigating-call-tree.gif)

ツリーの移動に伴い、**Locals** ビューの値が更新されることに注意してください。また、式の上にカーソルを置いて右クリックし、**Step into selection** オプション (Ctrl+B) を選択すると、部分式に移動できます。

![Step into selection](../../../images/debugger-step-into-selection.png)

## キーボードショートカット

コールツリーをすばやく移動するには、次のキーボードショートカットを使用します。

- **Step in (F11)** - は、コールツリー内の現在のアイテムの最初の子にステップインします。それ以上の子がない場合は、次の兄弟にジャンプする。
- **Step out (Shift-F11)** - は、コールツリー内の現在の項目の親にステップアウトします。
- **Step over (F10)** - は、次の関数パラメーター、算術演算の次の部分式にジャンプするか、現在の関数呼び出しにステップインします（それが自明でない関数の場合）。
- **Step back (Shift-F10)** - は、前の関数パラメーター、算術演算の前の部分式にジャンプし、現在の項目の前にパラメーターや部分式がない場合は、現在の項目の親にステップアウトします。
- **Step into selection (Ctrl-B)** - は、カーソル下の式にジャンプします。複数のパスが同じ式につながる場合（たとえば、ある小節が複数の小節とこれらの小節から参照されている場合）、パスを選択するためのダイアログが表示されます。
- **Next row (F9)** - は、もっとも内側のイテレータの行コンテキストを、イテレータの次の行にシフトします。
- **Previous row (Shift-F9)** - は、もっとも内側のイテレータの行コンテキストを、イテレータの前の行にシフトします。

## 制限事項および既知の問題点

現在、DAXデバッガーには以下のような制限があります。

- **現在、SQL Server 2016** 上のAnalysis Servicesに対しては、[TREATAS](https://dax.guide/TREATAS/) 関数に対応していないため、デバッグはサポートされていません。
- DAXクエリーのデバッグでは、DAXテーブル式のサブセットのみがサポートされます（たとえば、[SUMMARIZECOLUMNS](https://dax.guide/summarizecolumns) に依存するクエリーはデバッグ可能ですが、その他のテーブル関数は現在サポートされていません）。Power BIによって生成されたクエリ（Power BI Desktop Performance Analyzerを通じて取得可能）は、一般的にサポートされています。
- 暗黙のメジャーを含むクエリーや、クエリースコープによる計算は、現在サポートされていません。
- フィルタリングされたテーブル式から生成されたイテレータの最初の1000行をブラウズするとき、ブラウズウィンドウで選択された行が評価コンテキストスタックの現在の行コンテキストに対応するとは限りません（**Watch** ウィンドウで `CALCULATETABLE('<table name>')` と入力して現在の行コンテキストを調査してください）。

上記以外のデバッガーに関する問題が発生した場合は、TE3 Community Support GitHubサイトの[課題追跡](https://github.com/TabularEditor/TabularEditor3/issues)に投稿してください。

# Roadmap

DAXデバッガーは、上記の問題に対処し、より高性能なツールにするため、時間をかけて多くの機能を追加していく予定です。いつものように、フィードバックは大歓迎です。機能要望や一般的な議論については、[Discussions area](https://github.com/TabularEditor/TabularEditor3/discussion)を使用してください。

**Happy Debugging!**
